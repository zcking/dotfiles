#!/usr/bin/env zsh
{{/* Check if trivy is installed */}}
{{ if (lookPath "trivy") -}}

echo "--- Scanning chezmoi source for secrets ---"

# Run trivy filesystem scan on the source directory
# --exit-code 1 ensures the apply fails if secrets are found
trivy fs {{ .chezmoi.sourceDir }} \
    --scanners secret \
    --severity HIGH,CRITICAL,MEDIUM \
    --exit-code 1

if [ $? -eq 0 ]; then
    echo "--- Secret scan passed ---"
else
    echo "--- Secret scan failed! Fix the issues before applying. ---"
    exit 1
fi
{{- else }}
echo "WARNING: trivy not found, skipping secret scan."
exit 0
{{- end }}